<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            margin: 0 auto;
        }
        #box {
        }
        #box > div {
            height: 200px;
            width: 100px;
            border: 10px solid red;
            margin: 5%;
        }
        #box > div:nth-child(1) {
            height: 40px
        }
        #box > div:nth-child(2) {
            height: 240px
        }
        #box > div:nth-child(3) {
            height: 50px
        }
    </style>
</head>
<body>
    <div id="box">
        <div>item1</div>
        <div>item2</div>
        <div>item3</div>
        <div>item4</div>
        <div>item5</div>
        <div>item6</div>
        <div>item7</div>
        <div>item8</div>
        <div>item9</div>
        <div>item10</div>
        <div>item11</div>
        <div>item12</div>        
        <div>item13</div>
        <div>item14</div>
        <div>item15</div>
        <div>item16</div>
        <div>item17</div>
        <div>item18</div>
    </div>
    <script type="text/template" id="waterfall-tpl">
    {{#result}}
        <div class="item">
            <img src="{{image}}" width="{{width}}" height="{{height}}" />
        </div>
    {{/result}}
    {{obj.name}}
    {{count}}
    </script>
    <script src="../lib/waterfall.js"></script>
    <script>
        waterfall({
            container: '#box',
            cols: 4,
            path: '/demos/users.json'
        })
    </script>
    <script>
        var tpl = document.getElementById('waterfall-tpl').textContent.trim()
        var outerReg = /{{#\s*(.*?)\s*}}((.|\s)*){{\/\s*\1\s*}}/g
        var innerReg = /{{\s*(.*?)\s*}}/g
        var view = {
            result: [{
                image: '1.png',
                width: 50,
                height: 120
            }, {
                image: '2.png',
                width: 50,
                height: 120
            }],
            obj: {
                name: 'xuefei'
            },
            count: 10
        }
        class Template {
            constructor () {

            }
            render (tpl, view) {
                var outerReg = /{{#\s*(.*?)\s*}}((.|\s)*){{\/\s*\1\s*}}/g            
                var innerReg =/{{\s*(.*?)\s*}}/g
                tpl.replace(outerReg, function (match, $1, $2) {
                    if (view[$1]) {
                        if (Array.isArray(view[$1])) {
                            return view[$1].map(function (item) {
                                return $2.trim().replace(innerReg, function (match, $1) {
                                    return item[$1] || ''
                                })
                            }).join('')
                        }
                        return $2.trim().replace(innerReg, function (match, $1) {
                            return view[$1] || ''
                        })
                    } else {
                        return ''
                    }
                    console.log(match, $1, $2)
                })
                .trim()
                .replace(innerReg, function (match, $1) {
                    return $1.split('.').reduce((result, item) => {
                        return result[item]
                    }, view) || ''
                })
            }
        }
    </script>
</body>
</html>